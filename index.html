<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sri Lanka Grid Converter – High‑Tech UI</title>
  <meta name="description" content="Convert Lat/Lon to Kandawala (EPSG:5235), SLD99 (EPSG:5234) and UTM 44N with military grid (4/6/8-figure). Also convert grid references back to coordinates."/>

  <!-- proj4js -->
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.min.js"></script>

  <style>
    /* High-tech dark UI ------------------------------------------------- */
    :root{
      --bg1:#05060a; --bg2:#071028; --card:#081426; --glass:rgba(255,255,255,0.03);
      --accent:#6bd6ff; --accent-2:#7b6bff; --muted:#9fb0c8; --success:#5ee0a8;
      --radius:12px; --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;color: #e9f3ff;background: radial-gradient(1200px 600px at 10% 10%, rgba(83,126,255,0.06), transparent), linear-gradient(180deg,var(--bg1),var(--bg2));}
    .app{max-width:1200px;margin:28px auto;padding:20px}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);border-radius:16px;padding:18px;box-shadow: 0 8px 30px rgba(3,10,20,0.6);} 
    header{display:flex;gap:14px;align-items:center;margin-bottom:12px}
    .logo{width:54px;height:54px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#021028;font-weight:800;box-shadow:0 6px 18px rgba(107,214,255,0.08) inset}
    h1{font-size:18px;margin:0}
    p.lead{margin:6px 0 0;color:var(--muted);font-size:13px}

    .grid{display:grid;gap:12px}
    .row{display:flex;gap:12px;align-items:center}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}

    input[type=text], select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;font-size:14px}
    .controls{display:flex;gap:10px;align-items:center}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021028;padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    .output{display:grid;gap:12px;margin-top:14px}
    .card-small{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:10px}

    .value{font-family:var(--mono);font-size:16px;color:#dff6ff}
    .label{font-size:12px;color:var(--muted)}
    .gr{font-family:var(--mono);font-size:20px;color:var(--accent);font-weight:800}

    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}

    .actions{display:flex;gap:8px;margin-top:8px}
    .chip{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);font-size:13px}

    footer{margin-top:14px;color:var(--muted);font-size:13px}

    .tab-container{display:flex;gap:4px;margin-bottom:16px;background:rgba(255,255,255,0.02);padding:4px;border-radius:12px}
    .tab{flex:1;padding:8px 12px;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.2s;font-size:13px;font-weight:600}
    .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021028}
    .tab:not(.active){color:var(--muted)}

    .panel{display:none}
    .panel.active{display:block}

    .main-grid{display:grid;grid-template-columns:1fr 320px;gap:20px}

    @media (max-width:880px){.cols-2{grid-template-columns:1fr} .cols-3{grid-template-columns:1fr} .main-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div class="logo">SL</div>
        <div>
          <h1>Sri Lanka Grid Converter</h1>
          <p class="lead">Convert Lat/Lon ↔ Kandawala (EPSG:5235), SLD99 (EPSG:5234), UTM 44N and military Grid Reference (4/6/8‑figure)</p>
        </div>
      </header>

      <!-- Tabs -->
      <div class="tab-container">
        <div class="tab active" data-tab="coords-to-grid">Coordinates → Grid</div>
        <div class="tab" data-tab="grid-to-coords">Grid → Coordinates</div>
      </div>

      <div class="main-grid">
        <div>
          <!-- Panel 1: Coordinates to Grid -->
          <div id="coords-to-grid" class="panel active">
            <div class="grid">
              <div>
                <label class="small">Latitude (DD or DMS)</label>
                <input id="lat" type="text" placeholder="e.g. 8.597475 or 8°35'50.91\"N" />
              </div>
              <div>
                <label class="small">Longitude (DD or DMS)</label>
                <input id="lon" type="text" placeholder="e.g. 80.483883 or 80°29'1.98\"E" />
              </div>

              <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
                <div style="flex:1">
                  <label class="small">Grid Reference Precision</label>
                  <div class="row" style="flex-wrap:wrap">
                    <label class="chip"><input type="radio" name="precision" value="4"> 4‑figure</label>
                    <label class="chip"><input type="radio" name="precision" value="6" checked> 6‑figure</label>
                    <label class="chip"><input type="radio" name="precision" value="8"> 8‑figure</label>
                  </div>
                </div>
              </div>

              <div class="controls" style="margin-top:8px">
                <button id="convert" class="btn">Convert</button>
                <button id="clear" class="btn ghost">Clear</button>
                <div class="small" style="margin-left:auto">Inputs accept <strong>decimal</strong> or <strong>DMS</strong> formats</div>
              </div>

              <div class="small muted">Examples of DMS: <code>8°35'50.91"N</code> or <code>8 35 50.91 N</code> or <code>8:35:50.91N</code></div>
            </div>
          </div>

          <!-- Panel 2: Grid to Coordinates -->
          <div id="grid-to-coords" class="panel">
            <div class="grid">
              <div>
                <label class="small">Grid Reference</label>
                <input id="grid-ref" type="text" placeholder="e.g. GR 123456 or 123456" />
              </div>

              <div style="display:flex;gap:10px;align-items:center">
                <div style="flex:1">
                  <label class="small">Grid System</label>
                  <select id="grid-system">
                    <option value="kandawala">Kandawala (EPSG:5235)</option>
                    <option value="sld99">SLD99 (EPSG:5234)</option>
                    <option value="utm">UTM 44N (EPSG:32644)</option>
                  </select>
                </div>

                <div style="min-width:120px">
                  <label class="small">Figure Precision</label>
                  <select id="grid-precision">
                    <option value="4">4-figure</option>
                    <option value="6" selected>6-figure</option>
                    <option value="8">8-figure</option>
                  </select>
                </div>
              </div>

              <div class="controls" style="margin-top:8px">
                <button id="convert-reverse" class="btn">Convert to Coordinates</button>
                <button id="clear-reverse" class="btn ghost">Clear</button>
              </div>

              <div class="small muted">
                Examples: <code>GR 123456</code>, <code>123456</code>, <code>12345678</code> (8-figure), <code>1234</code> (4-figure)
              </div>
            </div>
          </div>
        </div>

        <aside>
          <div class="card-small">
            <div class="label">Quick actions</div>
            <div class="actions">
              <button id="copy-gr" class="btn ghost" title="Copy last GR">Copy last GR</button>
              <button id="copy-xy" class="btn ghost" title="Copy full E,N">Copy E,N</button>
              <button id="copy-coords" class="btn ghost" title="Copy lat,lon">Copy Lat,Lon</button>
              <button id="copy-gmap" class="btn ghost" title="Copy Google Maps link">Copy Maps link</button>
            </div>

            <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0" />
            <div class="label">Map preview</div>
            <div id="mapwrap" style="margin-top:8px;border-radius:8px;overflow:hidden;background:#071425;height:220px;display:flex;align-items:center;justify-content:center;color:var(--muted)">No point yet</div>
          </div>
        </aside>
      </div>

      <div class="output">
        <div id="out-wgs" class="card-small">
          <div class="label">WGS84 Coordinates</div>
          <div class="value" id="wgs-lat">—</div>
          <div class="small muted" id="wgs-lon">—</div>
        </div>

        <div id="out-grids" class="grid cols-3"></div>
      </div>

      <footer>
        <div class="small muted">Built with <a href="https://proj4js.org/" target="_blank">proj4js</a>. Supports bidirectional conversion between coordinates and grid references.</div>
      </footer>
    </div>
  </div>

  <script>
    // ------------------- Projection definitions -------------------
    // Kandawala / Sri Lanka Grid (EPSG:5235) – Everest 1830 (1937 adj.)
    proj4.defs("EPSG:5235", "+proj=tmerc +lat_0=7 +lon_0=80.77171333333333 +k=0.9999238418 +x_0=200000 +y_0=200000 +a=6377276.345 +rf=300.8017 +units=m +no_defs +towgs84=-97,787,86,0,0,0,0");

    // SLD99 / Sri Lanka Grid 1999 (EPSG:5234) – GRS80
    proj4.defs("EPSG:5234", "+proj=tmerc +lat_0=7 +lon_0=80.77171333333333 +k=0.9999238418 +x_0=200000 +y_0=200000 +ellps=GRS80 +units=m +no_defs");

    // WGS84 geographic
    proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");

    // UTM zone 44N
    proj4.defs("EPSG:32644", "+proj=utm +zone=44 +datum=WGS84 +units=m +no_defs");

    // ------------------- Utilities -------------------
    function parseDMS(input){
      if(!input && input !== 0) return NaN;
      const s = String(input).trim();
      // Plain decimal
      if(/^[-+]?\d+(?:\.\d+)?$/.test(s)) return parseFloat(s);

      // Flexible DMS: captures deg [min] [sec] [dir]
      const dms = s.match(/^(\d{1,3})(?:°|\s|:)?\s*(\d{1,2})?(?:'|\s|:)?\s*(\d{1,2}(?:\.\d+)?)?\s*(?:"|\s)?\s*([NnSsEeWw])?$/);
      if(!dms) return NaN;
      const deg = parseFloat(dms[1]) || 0;
      const min = dms[2] ? parseFloat(dms[2]) : 0;
      const sec = dms[3] ? parseFloat(dms[3]) : 0;
      const dir = dms[4] ? dms[4].toUpperCase() : null;
      let dd = Math.abs(deg) + (min/60) + (sec/3600);
      if(deg < 0) dd = -dd;
      if(dir){ if(dir === 'S' || dir === 'W') dd = -Math.abs(dd); }
      return dd;
    }

    function fmt(n, dp=0){ if(!isFinite(n)) return '—'; return Number(n).toLocaleString(undefined,{minimumFractionDigits:dp, maximumFractionDigits:dp}); }

    // figures e.g. 6 -> d=3 -> divisor = 10^(5-d)
    function makeGridRef(easting, northing, figures){
      const d = figures/2;
      const divisor = Math.pow(10, 5 - d);
      const mod = Math.pow(10, d);

      const ePartNum = Math.floor(easting / divisor) % mod;
      const nPartNum = Math.floor(northing / divisor) % mod;

      const ePart = String(ePartNum).padStart(d,'0');
      const nPart = String(nPartNum).padStart(d,'0');
      return { gr: `GR ${ePart}${nPart}`, ePart, nPart, d };
    }

    // Parse grid reference back to easting/northing
    function parseGridRef(gridRef, figures){
      if(!gridRef) return null;
      
      // Clean input - remove "GR" prefix and spaces
      const cleaned = gridRef.replace(/^GR\s*/i, '').replace(/\s/g, '');
      
      // Check if the length matches expected figures
      if(cleaned.length !== figures){
        return null;
      }
      
      const d = figures / 2; // digits per coordinate
      const divisor = Math.pow(10, 5 - d);
      
      // Split into easting and northing parts
      const ePart = cleaned.substring(0, d);
      const nPart = cleaned.substring(d);
      
      // Convert to full coordinates
      const easting = parseInt(ePart, 10) * divisor;
      const northing = parseInt(nPart, 10) * divisor;
      
      return { easting, northing, ePart, nPart };
    }

    // Build map iframe URL (embed) and standard google maps link
    function gmapLink(lat, lon){ return `https://maps.google.com/?q=${lat},${lon}`; }
    function gmapEmbed(lat, lon){ return `https://maps.google.com/maps?q=${lat},${lon}&output=embed`; }

    // ------------------- DOM & events -------------------
    const el = id => document.getElementById(id);
    const outWgsLat = el('wgs-lat');
    const outWgsLon = el('wgs-lon');
    const outGrids = el('out-grids');
    const mapWrap = el('mapwrap');

    let last = { gr:'', easting:null, northing:null, lat:null, lon:null, gmap:'' };

    function clearAll(){ 
      el('lat').value=''; 
      el('lon').value=''; 
      el('grid-ref').value='';
      outWgsLat.textContent='—'; 
      outWgsLon.textContent='—'; 
      outGrids.innerHTML=''; 
      mapWrap.textContent='No point yet'; 
      mapWrap.style.background=''; 
      last = {gr:'', easting:null, northing:null, lat:null, lon:null, gmap:''}; 
    }

    function copyToClipboard(text){ 
      navigator.clipboard.writeText(text).then(()=>{
        // Could add a toast notification here
      }).catch(()=>{ 
        alert('Copy failed – please copy manually.') 
      }); 
    }

    function renderMap(lat, lon){
      // show small iframe preview
      const src = gmapEmbed(lat, lon);
      mapWrap.innerHTML = `<iframe title="map" width="100%" height="100%" frameborder="0" style="border:0" src="${src}" allowfullscreen></iframe>`;
    }

    function displayResults(lat, lon, kand, sld, utm, figures) {
      // Kandawala GR uses kand[0], kand[1]
      const kandGr = makeGridRef(Math.round(kand[0]), Math.round(kand[1]), figures);

      // Build HTML for three cards
      outGrids.innerHTML = '';

      // card helper
      function cardHTML(title, tag, easting, northing, grObj, lat, lon){
        return `
          <div class="card-small">
            <div class="label">${title} <span class="small muted">${tag}</span></div>
            <div style="margin-top:8px">
              <div class="label">Easting</div>
              <div class="value">${fmt(easting,0)} m ${grObj ? `→ <span class="gr">${grObj.ePart}</span>` : ''}</div>
              <div class="label" style="margin-top:6px">Northing</div>
              <div class="value">${fmt(northing,0)} m ${grObj ? `→ <span class="gr">${grObj.nPart}</span>` : ''}</div>

              ${grObj ? `<div style="margin-top:8px"><span class="label">Grid Reference (${figures}-figure)</span>
              <div class="gr">${grObj.gr}</div></div>` : ''}

              <div style="margin-top:8px" class="small muted"> <a target="_blank" href="${gmapLink(lat,lon)}">Open in Google Maps</a> </div>
            </div>
          </div>
        `;
      }

      outGrids.insertAdjacentHTML('beforeend', cardHTML('Kandawala / Sri Lanka Grid','EPSG:5235', kand[0], kand[1], kandGr, lat, lon));
      outGrids.insertAdjacentHTML('beforeend', cardHTML('SLD99 / Sri Lanka Grid 1999','EPSG:5234', sld[0], sld[1], null, lat, lon));
      outGrids.insertAdjacentHTML('beforeend', cardHTML('UTM Zone 44N (WGS84)','EPSG:32644', utm[0], utm[1], null, lat, lon));

      // WGS display
      outWgsLat.textContent = `Lat ${lat.toFixed(6)}°`;
      outWgsLon.textContent = `Lon ${lon.toFixed(6)}°`;

      // Map
      renderMap(lat, lon);

      // Save last
      last.easting = Math.round(kand[0]); 
      last.northing = Math.round(kand[1]); 
      last.gr = kandGr.gr; 
      last.lat = lat;
      last.lon = lon;
      last.gmap = gmapLink(lat,lon);
    }

    function convert(){
      const latRaw = el('lat').value.trim();
      const lonRaw = el('lon').value.trim();
      const lat = parseDMS(latRaw);
      const lon = parseDMS(lonRaw);
      if(!isFinite(lat) || !isFinite(lon)){
        alert('Enter valid Latitude and Longitude (decimal or DMS).'); return;
      }

      // Compute projections
      const kand = proj4('EPSG:4326','EPSG:5235',[lon, lat]); // [E,N]
      const sld  = proj4('EPSG:4326','EPSG:5234',[lon, lat]);
      const utm  = proj4('EPSG:4326','EPSG:32644',[lon, lat]);

      // chosen precision
      const figures = parseInt(document.querySelector('input[name="precision"]:checked').value,10);

      displayResults(lat, lon, kand, sld, utm, figures);
    }

    function convertReverse(){
      const gridRefRaw = el('grid-ref').value.trim();
      const gridSystem = el('grid-system').value;
      const figures = parseInt(el('grid-precision').value, 10);

      if(!gridRefRaw){
        alert('Enter a valid grid reference.'); return;
      }

      // Parse the grid reference
      const parsed = parseGridRef(gridRefRaw, figures);
      if(!parsed){
        alert(`Invalid grid reference format. Expected ${figures} digits total.`); return;
      }

      let projectionCode;
      switch(gridSystem){
        case 'kandawala': projectionCode = 'EPSG:5235'; break;
        case 'sld99': projectionCode = 'EPSG:5234'; break;
        case 'utm': projectionCode = 'EPSG:32644'; break;
        default: alert('Unknown grid system'); return;
      }

      try {
        // Convert from grid coordinates to WGS84
        const coords = proj4(projectionCode, 'EPSG:4326', [parsed.easting, parsed.northing]);
        const lon = coords[0];
        const lat = coords[1];

        // Now compute all projections for display
        const kand = proj4('EPSG:4326','EPSG:5235',[lon, lat]);
        const sld  = proj4('EPSG:4326','EPSG:5234',[lon, lat]);
        const utm  = proj4('EPSG:4326','EPSG:32644',[lon, lat]);

        displayResults(lat, lon, kand, sld, utm, figures);

      } catch(error) {
        alert('Error converting coordinates. Please check your input.');
        console.error('Conversion error:', error);
      }
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and panels
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding panel
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
        
        // Clear results when switching tabs
        clearAll();
      });
    });

    // Wire buttons
    el('convert').addEventListener('click', convert);
    el('clear').addEventListener('click', clearAll);
    el('convert-reverse').addEventListener('click', convertReverse);
    el('clear-reverse').addEventListener('click', clearAll);

    // Copy buttons - initially set up with alerts
    el('copy-gr').onclick = () => { if(last.gr) copyToClipboard(last.gr); else alert('No GR to copy'); };
    el('copy-xy').onclick = () => { if(last.easting!==null) copyToClipboard(`${last.easting}, ${last.northing}`); else alert('No coordinates'); };
    el('copy-coords').onclick = () => { if(last.lat!==null) copyToClipboard(`${last.lat}, ${last.lon}`); else alert('No coordinates'); };
    el('copy-gmap').onclick = () => { if(last.gmap) copyToClipboard(last.gmap); else alert('No map link'); };

    // initial clear
    clearAll();
  </script>
</body>
</html>
