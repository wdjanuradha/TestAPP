<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sri Lanka Grid Converter (Kandawala)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.6/proj4.js"></script>
  <style>
    body {
      background: #0d1117;
      color: #e6edf3;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
    }
    header {
      background: #161b22;
      padding: 12px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      color: #58a6ff;
    }
    .container {
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    label {
      font-size: 14px;
      display: block;
      margin-top: 12px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
    }
    input, select {
      background: #21262d;
      color: #e6edf3;
    }
    button {
      background: #238636;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: #2ea043; }
    .output {
      margin-top: 20px;
      padding: 15px;
      background: #161b22;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.6em;
    }
    iframe {
      width: 100%;
      height: 400px;
      border: none;
      border-radius: 6px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
<header>Sri Lanka Grid Converter – Kandawala / WGS84</header>
<div class="container">

  <!-- Forward: Lat/Lon → Grid -->
  <label>Latitude (WGS84)</label>
  <input id="lat" type="number" step="any" placeholder="e.g. 7.8731">
  <label>Longitude (WGS84)</label>
  <input id="lon" type="number" step="any" placeholder="e.g. 80.7718">
  <button id="convert">Convert Lat/Lon → Grid</button>

  <!-- Reverse: Grid → Lat/Lon -->
  <label style="margin-top:20px;">Military Grid Reference (4/6/8-figure)</label>
  <input id="gridRef" type="text" placeholder="e.g. 681876">
  <button id="convert-gr">Convert Grid → Lat/Lon</button>

  <!-- Output -->
  <div class="output">
    <div><strong>WGS84:</strong> <span id="out-wgs"></span></div>
    <div><strong>Kandawala:</strong> <span id="out-kanda"></span></div>
    <div><strong>SLD99:</strong> <span id="out-sld"></span></div>
    <div><strong>UTM 44N:</strong> <span id="out-utm"></span></div>
    <div><strong>Military GR:</strong> <span id="out-gr"></span></div>
  </div>

  <!-- Map -->
  <iframe id="map"></iframe>
</div>

<script>
  // === PROJ4 DEFINITIONS ===
  proj4.defs("EPSG:5235","+proj=tmerc +lat_0=7 +lon_0=81 +k=0.9999238418 +x_0=200000 +y_0=200000 +a=6377276.345 +rf=300.8017 +towgs84=-97,787,86,0,0,0,0 +units=m +no_defs"); // Kandawala
  proj4.defs("EPSG:5236","+proj=tmerc +lat_0=0 +lon_0=81 +k=0.999923 +x_0=200000 +y_0=200000 +datum=WGS84 +units=m +no_defs"); // SLD99
  proj4.defs("EPSG:32644","+proj=utm +zone=44 +datum=WGS84 +units=m +no_defs"); // UTM 44N

  const el = id => document.getElementById(id);

  // Parse GR string (4,6,8 figure)
  function parseGridRef(gr, figures=6){
    const clean = gr.replace(/[^0-9]/g,'');
    const d = figures/2;
    if(clean.length !== figures) return null;
    const ePart = clean.substring(0,d);
    const nPart = clean.substring(d);
    const divisor = Math.pow(10, 5-d);
    const easting = parseInt(ePart) * divisor + divisor/2;
    const northing = parseInt(nPart) * divisor + divisor/2;
    return {easting, northing};
  }

  // GR → Lat/Lon
  function grToLatLon(gr, figures=6){
    const parsed = parseGridRef(gr, figures);
    if(!parsed) return null;
    const {easting, northing} = parsed;
    const [lon, lat] = proj4("EPSG:5235","EPSG:4326",[easting, northing]);
    return {lat, lon};
  }

  // Lat/Lon → GR (6-figure default)
  function toGridRef(easting, northing, figures=6){
    const d = figures/2;
    const divisor = Math.pow(10, 5-d);
    const ePart = Math.floor(easting/divisor).toString().padStart(d,"0");
    const nPart = Math.floor(northing/divisor).toString().padStart(d,"0");
    return ePart+nPart;
  }

  // Map Renderer
  function renderMap(lat, lon){
    const url = `https://www.google.com/maps?q=${lat},${lon}&t=h&z=15&output=embed`;
    el("map").src = url;
  }

  // === Forward Conversion ===
  el("convert").addEventListener("click", ()=>{
    const lat = parseFloat(el("lat").value);
    const lon = parseFloat(el("lon").value);
    if(isNaN(lat)||isNaN(lon)){ alert("Enter valid Lat/Lon"); return; }

    // Transform
    const [kX,kY] = proj4("EPSG:4326","EPSG:5235",[lon,lat]);
    const [sX,sY] = proj4("EPSG:4326","EPSG:5236",[lon,lat]);
    const [uX,uY] = proj4("EPSG:4326","EPSG:32644",[lon,lat]);

    const gr = toGridRef(kX,kY,6);

    el("out-wgs").textContent = `Lat ${lat.toFixed(6)}, Lon ${lon.toFixed(6)}`;
    el("out-kanda").textContent = `E ${kX.toFixed(2)}, N ${kY.toFixed(2)}`;
    el("out-sld").textContent = `E ${sX.toFixed(2)}, N ${sY.toFixed(2)}`;
    el("out-utm").textContent = `E ${uX.toFixed(2)}, N ${uY.toFixed(2)}`;
    el("out-gr").textContent = `GR ${gr}`;

    renderMap(lat, lon);
  });

  // === Reverse Conversion ===
  el("convert-gr").addEventListener("click", ()=>{
    const grRaw = el("gridRef").value.trim();
    const len = grRaw.replace(/[^0-9]/g,'').length;
    if(![4,6,8].includes(len)){ alert("Enter 4, 6, or 8 figure GR"); return; }

    const result = grToLatLon(grRaw,len);
    if(!result){ alert("Invalid GR"); return; }
    const {lat, lon} = result;

    // Transform again for outputs
    const [kX,kY] = proj4("EPSG:4326","EPSG:5235",[lon,lat]);
    const [sX,sY] = proj4("EPSG:4326","EPSG:5236",[lon,lat]);
    const [uX,uY] = proj4("EPSG:4326","EPSG:32644",[lon,lat]);
    const gr = toGridRef(kX,kY,len);

    el("out-wgs").textContent = `Lat ${lat.toFixed(6)}, Lon ${lon.toFixed(6)}`;
    el("out-kanda").textContent = `E ${kX.toFixed(2)}, N ${kY.toFixed(2)}`;
    el("out-sld").textContent = `E ${sX.toFixed(2)}, N ${sY.toFixed(2)}`;
    el("out-utm").textContent = `E ${uX.toFixed(2)}, N ${uY.toFixed(2)}`;
    el("out-gr").textContent = `GR ${gr}`;

    renderMap(lat, lon);
  });
</script>
</body>
</html>
